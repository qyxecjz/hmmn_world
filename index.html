<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>hmmn・WorldTour (iPhone Fixed)</title>
    <style>
        body {
            margin: 0; padding: 0; background-color: #000;
            display: flex; justify-content: center; align-items: center;
            height: 100vh; overflow: hidden; touch-action: none;
        }
        #game-container {
            position: relative; width: 100vw; height: 56.25vw;
            max-height: 100vh; max-width: 177.78vh;
            background: #222;
        }
        canvas { width: 100%; height: 100%; display: block; image-rendering: pixelated; }
        
        /* 操作パネル */
        #controls {
            position: absolute; bottom: 5%; width: 100%;
            display: flex; justify-content: space-between;
            padding: 0 5%; box-sizing: border-box; pointer-events: none;
        }
        .left-group, .right-group { display: flex; gap: 15px; pointer-events: auto; }
        .button {
            width: 70px; height: 70px; background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.4); border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            color: white; font-weight: bold; touch-action: none;
        }
        .button:active { background: rgba(255,255,255,0.5); transform: scale(0.9); }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    <div id="controls">
        <div class="left-group">
            <div id="btn-left" class="button">←</div>
            <div id="btn-right" class="button">→</div>
        </div>
        <div class="right-group">
            <div id="btn-shift" class="button">Dash</div>
            <div id="btn-up" class="button">W</div>
            <div id="btn-space" class="button">Jump</div>
        </div>
    </div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = 1920; canvas.height = 1080;

let currentStageIndex = 0;
const keys = { a: false, d: false, w: false, space: false, shift: false };

// --- 音声管理 (iPhone対策: 配列で一括管理) ---
const sounds = {
    normal: new Audio('bgm.mp3'),
    stage5: new Audio('bgm5.mp3'),
    wiiu: new Audio('WiiU.mp3'),
    door: new Audio('door.mp3')
};

// 全ての音声をループ設定にする
sounds.normal.loop = true;
sounds.stage5.loop = true;
sounds.wiiu.loop = true;

let isAudioUnlocked = false;

// iPhone向けの強力なアンロック関数
function unlockAllAudio() {
    if (isAudioUnlocked) return;
    
    // 全ての音源を同時に一瞬だけ再生する
    Object.values(sounds).forEach(s => {
        s.play().then(() => {
            s.pause();
            s.currentTime = 0;
        }).catch(e => console.log("Unlock error"));
    });
    isAudioUnlocked = true;
}

// --- 音楽切り替えロジック ---
function playBGM() {
    // 全BGMを一時停止
    [sounds.normal, sounds.stage5, sounds.wiiu].forEach(s => {
        s.pause();
    });

    let target;
    if (currentStageIndex === 4) target = sounds.stage5;
    else if (currentStageIndex === 5) target = sounds.wiiu;
    else target = sounds.normal;

    // iPhoneでは play() の前に currentTime をいじると失敗することがあるため
    // play() を呼んでからリセットをかける
    const playPromise = target.play();
    if (playPromise !== undefined) {
        playPromise.then(() => {
            // 再生成功
        }).catch(error => {
            console.log("iPhone auto-play blocked. Waiting for touch.");
        });
    }
}

// --- 画像読み込み ---
const playerImgs = [new Image(), new Image(), new Image()];
playerImgs[0].src = 'ham.jpg'; playerImgs[1].src = 'ham2.jpg'; playerImgs[2].src = 'ham3.jpg';
const itemImgs = [new Image(), new Image()];
itemImgs[0].src = 'item.jpg'; itemImgs[1].src = 'item2.jpg';
const doorImg = new Image(); doorImg.src = 'door.jpg';

const bgImgs = [];
['bg1.png','bg2.png','bg3.png','bg4.png','bg5.png','bg6.png'].forEach(src => {
    const img = new Image(); img.src = src; bgImgs.push(img);
});

// --- ゲームオブジェクト ---
const player = { x: 960, y: 650, width: 200, height: 200, dy: 0, gravity: 0.5, isGround: false, img: playerImgs[0] };
const door = { x: 0, y: 0, width: 160, height: 180, visible: false };
const item1 = { x: 0, y: 0, width: 100, height: 100, visible: false };
const item2 = { x: 0, y: 0, width: 100, height: 100, visible: false };

// --- 入力イベント ---
const handleInteraction = () => {
    if (!isAudioUnlocked) {
        unlockAllAudio();
        playBGM();
    }
};

window.addEventListener('keydown', (e) => {
    handleInteraction();
    const k = e.key.toLowerCase();
    if(k==='a') keys.a=true; if(k==='d') keys.d=true; if(k==='w') keys.w=true;
    if(k==='shift') keys.shift=true; if(e.code==='Space') keys.space=true;
});
window.addEventListener('keyup', (e) => {
    const k = e.key.toLowerCase();
    if(k==='a') keys.a=false; if(k==='d') keys.d=false; if(k==='w') keys.w=false;
    if(k==='shift') keys.shift=false; if(e.code==='Space') keys.space=false;
});

const setupBtn = (id, key) => {
    const el = document.getElementById(id);
    el.addEventListener('touchstart', (e) => { e.preventDefault(); handleInteraction(); keys[key]=true; });
    el.addEventListener('touchend', (e) => { e.preventDefault(); keys[key]=false; });
};
setupBtn('btn-left','a'); setupBtn('btn-right','d'); setupBtn('btn-up','w');
setupBtn('btn-space','space'); setupBtn('btn-shift','shift');

function resetObjects() {
    let ground = [0,1,3].includes(currentStageIndex) ? 650 : 750;
    door.visible = (currentStageIndex < 5 && Math.random() < 0.3);
    if(door.visible) { door.x = 400 + Math.random()*1000; door.y = ground + 200 - 180; }
    item1.visible = Math.random() < 0.4;
    if(item1.visible) { item1.x = 200 + Math.random()*600; item1.y = ground + 200 - 100; }
    item2.visible = Math.random() < 0.3;
    if(item2.visible) { item2.x = 1100 + Math.random()*600; item2.y = ground + 200 - 100; }
}

function update() {
    const speed = keys.shift ? 12 : 5;
    if(keys.a) player.x -= speed; if(keys.d) player.x += speed;

    let ground = [0,1,3].includes(currentStageIndex) ? 650 : 750;
    if(keys.space && player.isGround) { player.dy = -15; player.isGround = false; }
    player.dy += player.gravity; player.y += player.dy;
    if(player.y >= ground) { player.y = ground; player.dy = 0; player.isGround = true; }

    const col = (o) => player.x < o.x+o.width && player.x+200 > o.x && player.y < o.y+o.height && player.y+200 > o.y;
    if(item1.visible && col(item1)) { item1.visible = false; player.img = playerImgs[1]; }
    if(item2.visible && col(item2)) { item2.visible = false; player.img = playerImgs[2]; }
    if(door.visible && keys.w && col(door)) { sounds.door.play(); currentStageIndex = 5; player.x = 960; playBGM(); resetObjects(); }

    let oldIdx = currentStageIndex;
    if(player.x > 1920) { currentStageIndex = (currentStageIndex === 3) ? (Math.random()<0.4?4:0) : (currentStageIndex >= 4 ? 0 : currentStageIndex+1); player.x = 0; }
    if(player.x < -200) { currentStageIndex = (currentStageIndex === 0) ? 3 : (currentStageIndex >= 4 ? 3 : currentStageIndex-1); player.x = 1720; }
    
    if(oldIdx !== currentStageIndex) { playBGM(); resetObjects(); }
}

function draw() {
    ctx.clearRect(0,0,1920,1080);
    if(bgImgs[currentStageIndex]) ctx.drawImage(bgImgs[currentStageIndex], 0, 0, 1920, 1080);
    if(door.visible) ctx.drawImage(doorImg, door.x, door.y, 160, 180);
    if(item1.visible) ctx.drawImage(itemImgs[0], item1.x, item1.y, 100, 100);
    if(item2.visible) ctx.drawImage(itemImgs[1], item2.x, item2.y, 100, 100);
    ctx.drawImage(player.img, player.x, player.y, 200, 200);
}

function loop() { update(); draw(); requestAnimationFrame(loop); }
resetObjects(); loop();
</script>
</body>
</html>
